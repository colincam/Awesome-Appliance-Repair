{% extends "layout.html" %}
{% block body %}
<script type="text/javascript">
$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

function formReset(){
        document.getElementById("update-form").reset();
        $("#update").hide();
    }
    
function validateDate(input){
    var valid = false;
    var sdate = input.split('-')
    if (!/^\d{4}$/.test(sdate[0]) || !/^\d{2}$/.test(sdate[1]) || !/^\d{2}$/.test(sdate[2])){
        alert('not valid date pattern, please use yyyy-mm-dd');
    } else {
        var yearfield = sdate[0]
        var monthfield = sdate[1]
        var dayfield = sdate[2]
        var dayobj = new Date(yearfield, monthfield-1, dayfield)
        if ((dayobj.getMonth()+1!=monthfield)||(dayobj.getDate()!=dayfield)||(dayobj.getFullYear()!=yearfield))
            alert("Invalid Day, Month, or Year range detected. Please correct and submit again.")
        else
            valid = true
    }
    
    return valid
}
    
function updateValidate(){
    var valid = true;
    var re = /\d{4}\-\d{2}\-\d{2}/;
    var field = $("#update-form input[name='new_value']").val();
    if (field.toUpperCase() == 'NONE' || field.toUpperCase() == 'NULL' || validateDate(field)){
        valid = true;
    } else {
        valid = false;
    };
    
    if (valid == false){
        alert("please enter a date in the form yyyy-mm-dd \n or the string 'null' or 'none'");
        return false;
    }        
}

$(document).ready(function() {

    $(".dispatch-closeme").bind('click', function(ev){
        $(".error, .flashes").hide();
    });
    
    $("#jobs-table").tablesorter({ 
        // sort on the first column and third column, order asc 
        sortList: [[1,0]] 
    });
    
    $(".job_status, .job_date").on('click', function(){
        $(".flashes").empty();
        $("#update").empty();
        var $td = $(this)
        var field_value = $td.text();
        var field_name = $td.closest('table').find('th').eq($td.index()).attr("id");
        var job_id = $td.parent().children().eq(0).text();
        
        // Submit button sends 'POST', no ajax needed.
        if (field_name == "job_status"){
            $("#update").html("<form id='update-form' action='' method=post > <fieldset> <legend>Update Field</legend> Job ID: " + job_id + " <input type=hidden name='job_id' value=" + job_id +" ><br>Column: " + field_name + "<input type=hidden name='field_value' value=" + field_name + " ><input type=hidden name='current_value' value=" + field_value + " > <br><br><input type='radio' name='new_value' value='pending'>pending<br> <input type='radio' name='new_value' value='completed'>completed<br><br> <input type=submit value=Update> <input type='button' onclick='formReset()' value='Cancel'></fieldset> </form>").show();
            } else {
            $("#update").html("<form id='update-form' action='' onsubmit='return updateValidate();' method=post >\
            <fieldset>\
                 <legend>Update Field</legend> Job ID: " + job_id + "\
                 <input type=hidden name='job_id' value=" + job_id +" >\
                 <br>Column: " + field_name + "\
                 <input type=hidden name='field_value' value='" + field_name + "' >\
                 <br><br> Enter Date yyyy-mm-dd: <input type='text' name='new_value' value='" + field_value + "'>\
                 <br><br> <input type=submit value=Update>\
                 <input type='button' onclick='formReset()' value='Cancel'>\
            </fieldset> </form>").show();
            
            }
            
        if (field_value == 'pending'){
            $("#update-form input[type='radio'][value='pending']").prop('checked', true)
        } else if (field_value == 'completed'){
            $("#update-form input[type='radio'][value='completed']").prop('checked', true)
        }
        
        
        
        
    });
    
    
    //TODO: form validation.

});

</script>

<div id="navbar">
<a href="{{ url_for('logout') }}">logout</a>
</div>

<div style="padding: 16px">
    <p class="aarhead">User: {{ user }},&nbsp;&nbsp;&nbsp;&nbsp;{{ title }}</p>
    <p>Here are the jobs in the database:</p>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul class="flashes"><img style="float:left; width: 18px; margin:auto; padding-right: 40px" class='dispatch-closeme' src="static/images/close.png" />
        {% for message in messages %}
          <li>{{ message }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}


    <div id="jobs-table-div">
        <table id="jobs-table" class="tablesorter">
            <thead>
                <tr><th id='jid'>job<br>ID</th><th id='cid'>cust<br>ID</th><th id='lname'>Last Name</th><th id='make'>Make</th><th id='appliance'>Appliance</th><th id='job_status'>Job Status</th><th id='appointment'>Appointment</th><th id='description'>Description</th>
                </tr>
            </thead>
            <tbody id="result">        
            {% for row in result %}
                <tr id="{{ loop.index }} "class="{{ loop.cycle('odd', 'even') }}">
                {% for cell in row %}
                    {% if loop.index == 6 %}
                    <td class="job_status">{{ cell }}</td>
                    {% elif loop.index == 7 %}
                    <td class="job_date">{{ cell }}</td>
                    {% else %}
                    <td>{{ cell }}</td>
                    {% endif %}
                {% endfor %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    <pre id='tst'></pre>
    <p style="display: none">{{ses}}</p>
    <pre style="display: none">{{reqenviron|pprint()}}</pre>
    <div id="update">&nbsp;</div>
    {% if error %}
        <div><img class='closeme' src="static/images/close.png" /><strong>Error:</strong> {{ error }}</div>
    {% endif %}

</div>
{% endblock %}
